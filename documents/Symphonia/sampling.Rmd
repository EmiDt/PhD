---
title: "Sampling"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
csl: /home/sylvain/Documents/Bibliography/csl/mee.csl
bibliography: /home/sylvain/Documents/Bibliography/library.bib
link-citations: yes
---

```{r setup, include=FALSE}
rm(list = ls()) ; invisible(gc()) ; set.seed(42)
library(knitr)
library(flexdashboard)
library(rgdal)
library(raster)
library(leaflet)
library(starmie)
library(rstan)
library(bayesplot)
library(abind)
library(ggrepel)
library(tidyverse)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 6, fig.width = 8,
    cache = T, cache.lazy = F)
```

# General

##

### To Do

* Order big shot weights and rope
* Order 50 mL centrifuge tubes (to replace those from the lab used for wood sample)
* Order Eppendorf PCR tube 0.5 mL  (to replace those from the lab used for latex samples)
* Book the car for following weeks next week (mail Carole and GHP)
* Check maps with Saint omer
* Register in Paracou Charte
* Prepare protocol cheatsheets
* Prepare sampling sheets

* Book the car for the first week (mail Carole and GHP)
* Prepare maps
* Look for sattelite phone
* Prepare Dawkins index cheatsheets

### Docs

* [Dawkins index](/home/sylvain/Documents/Dawkins_index.pdf)

##

### Planning

* Starting from $30^{th}$ of October
* During 25 to 30 days
* End between $4^{th}$ of December and $11^{th}$ of December
* Sampling from 7 AM until 3 PM
* Fresh measurement and herbarium preparation to finsih the day

# Sampling

##

### Material

* **Sattelite phone**
* **GPS camera**
* Big Shot
* Helmets
* Big shot weights
* Big shot rope
* Bag for big shot rope
* Sécateur
* Micromêtre
* Spad
* Labels
* Ziplocks
* Tea bags
* Silicagel
* Black plastic bag
* Tissue
* Water spray
* Tubes filled with for wood
* Eppendorf for latex
* Jumelles
* Dawkins index cheatsheet
* Protocol cheatsheet
* Maps
* Sampling sheets
* Wite paper
* Pens
* Markers for leaves

##

### Protocol

*Prepare bags the day before*

* Note the date
* Note the tree code (Plot/Square/Id + idArbre)
* Evaluate tree Dawkins index
* Sample if possible canopy sun leaves
* Note the time
* Note the position of the sampled branch in the tree (at least sun or shadow)
* Select four leaves for genetic/metabolites
* Put the leaves for genetic/metabolite in a tea bag with silicagel inside a labelled ziplock
* Put genetic/metabolite samples in a touc
* Select 6 leaves for functional measurement
* Select three for immediate measurement
* Measure with SPAD in three points
* Measure with micrometer in three points
* Label measured leaves with marker
* Label a ziplock
* But a wet tissue in a ziplock
* Fill a ziplock with CO2
* Pull all the leaves in the ziplock
* Put functional samples in a double black plastic bag 

# Samples

```{r trees}
path <- "/home/sylvain//Documents/BIOGECO/PhD/data/Paracou/"
trees <- read.csv(file.path(path, 'trees/Symphonia_Paracou.csv'),
                  dec=",", stringsAsFactors = F)
trees <- trees %>% 
  filter(campagne == 2015) %>% 
  filter(code_vivant == 1) %>% 
  filter(code_mesure == 0) %>% 
  filter(n_parcelle != 18) %>% 
  mutate(treatment = c(c('C', 'T1', 'T2', 'T3', 
                         'T2', 'C', 'T1', 'T3',
                         'T1', 'T2', 'C', 'T3'), 
                       rep('B', 4))[n_parcelle])
```

```{r env}
# global crs definition
crs <- '+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0'
# limits
limits <- readOGR(file.path(path, 'limits'), "OverallPlots", verbose = F)
limits <- spTransform(limits, CRSobj = crs)
# plot(limits)
# contour
contour <- readOGR(file.path(path, 'topography'), "ContourLinePlots", verbose = F)
contour <- spTransform(contour, CRSobj = crs)
# plot(contour)
# water table
WT <- readOGR(file.path(path, 'hydrology'), "WaterTable", verbose = F)
WT <- spTransform(WT, CRSobj = crs)
WT_pal <- colorFactor('Blues', as.factor(WT$TypeWatEN), reverse = T)
# plot(WT, col = WT_pal(WT$TypeWatEN))
# topo
topo <- readOGR(file.path(path, 'hydrology'), "TopographicLevels", verbose = F)
topo <- spTransform(topo, CRSobj = crs)
topo_pal <- colorFactor('Set3', as.factor(topo$TypeTopoEN), reverse = T)
# plot(topo, col = topo_pal(topo$TypeTopoEN))
# gaps
gaps <- readOGR(file.path(path, 'logging'), "Gaps", verbose = F)
gaps <- spTransform(gaps, CRSobj = crs)
# plot(gaps, col = 'green')
# Trees to plot
treesXY <- trees
coordinates(treesXY) <- ~Xutm + Yutm
proj4string(treesXY) <- '+proj=utm +zone=22 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0'
treesXY <- spTransform(treesXY, CRSobj = crs)
tree_pal <- colorFactor(c('darkgreen', 'black', 'firebrick'), as.factor(treesXY$espece))
# plot(treesXY, col = tree_pal(treesXY$espece), pch = 16)
```

```{r interpolation}
trees <- trees %>% 
  mutate(WT = as.character((treesXY %over% WT)$TypeWatEN)) %>% 
  mutate(WT = ifelse(is.na(WT), 'unknwon', WT)) %>% 
  mutate(topo = as.character((treesXY %over% topo)$TypeTopoEN)) %>% 
  mutate(topo = ifelse(is.na(topo), 'unknwon', topo)) %>% 
  mutate(gap = as.numeric(!(is.na((treesXY %over% gaps)$Plot))))
```

```{r previous sampling}
path <- "/home/sylvain//Documents/BIOGECO/PhD/data/links/"
SymphoGrowth <- read.csv(file.path(path, 'Symphonia_SymphoGrowth.csv'),
                  dec=",", stringsAsFactors = F) %>% 
  mutate(individual = gsub('P', '', individual)) %>% 
  separate(individual, c("n_parcelle", "n_carre", "n_arbre" ), '-', convert = T) %>% 
  distinct() %>% 
  mutate(SymphoGrowth = 1)
GbS <- read.csv(file.path(path, 'Symphonia_Match_btw_Gbs_otherDatasets.csv'),
                  dec=",", stringsAsFactors = F) %>% 
  select(Code_Par) %>% 
  mutate(Code_Par = gsub('P', '', Code_Par)) %>% 
  separate(Code_Par, c("n_parcelle", "n_carre", "n_arbre" ), '-', convert = T) %>% 
  distinct() %>% 
  mutate(GbS = 1)
# CROPS <- read.csv(file.path(path, 'NA'),
#                   dec=",", stringsAsFactors = F)
# DROUGHT <- read.csv(file.path(path, 'NA'),
#                   dec=",", stringsAsFactors = F)
trees <- trees %>% 
  left_join(GbS) %>% 
  mutate(GbS = ifelse(is.na(GbS), 0, GbS)) %>% 
  left_join(SymphoGrowth) %>% 
  mutate(SymphoGrowth = ifelse(is.na(SymphoGrowth), 0, SymphoGrowth))
rm(SymphoGrowth, GbS)
```

##

> Original headcounts

### Species headcount

```{r species}
trees %>% 
  reshape2::dcast(espece ~ 1) %>%
  kable()
```

### Species and gaps headcount

```{r gap}
trees %>% 
  reshape2::dcast(gap ~ espece) %>%
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

### Species and water table depth headcount

```{r WT}
trees %>% 
  reshape2::dcast(WT ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

### Species and topography headcount

```{r topo}
trees %>% 
  reshape2::dcast(topo ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

### Species and treatment headcount

```{r treatment}
trees %>% 
  reshape2::dcast(treatment ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

###  Species and plot headcount

```{r plot}
trees %>% 
  reshape2::dcast(n_parcelle ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

##

```{r selection, cache=F}
trees <- trees %>% 
  mutate(sel = 0) %>% 
  mutate(sel = ifelse(SymphoGrowth == 1, 1, sel)) %>% 
  mutate(sel = ifelse(GbS == 1, 1, sel)) %>% 
  mutate(sel = ifelse(espece == "globulifera", 1, sel)) %>% 
  mutate(sel = ifelse(gap == 1, 1, sel)) %>% 
  mutate(sel = ifelse(WT == "unknwon", 1, sel)) %>% 
  mutate(sel = ifelse(WT == "0 : accompanying water-table of the stream", 1, sel)) %>% 
  mutate(sel = ifelse(WT == "Watertable between 0 and 60 cm", 1, sel)) %>% 
  mutate(sel = ifelse(WT == "Watertable between 60 and 100 cm", 1, sel)) %>% 
  mutate(sel = ifelse(topo == "unknwon", 1, sel))
P <- row.names(trees[trees$topo == 'Plateau' & trees$sel != 1,])  
S <- row.names(trees[trees$topo == 'Slope' & trees$sel != 1,])
nb <- (400-sum(trees$sel))/2
P <- sample(P, floor(nb))
S <- sample(S, ceiling(nb))
trees[P,]$sel <- 1
trees[S,]$sel <- 1
treesXY@data$sel <- trees$sel
rm(nb, P, S)
```

> Number of trees selected: `r sum(trees$sel)`

### Selected species headcount

```{r speciessel, cache=F}
trees %>% 
  filter(sel == 1) %>% 
  reshape2::dcast(espece ~ 1) %>%
  kable()
```

### Selected species and gaps headcount

```{r gapsel, cache=F}
trees %>% 
  filter(sel == 1) %>% 
  reshape2::dcast(gap ~ espece) %>%
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

### Selected species and water table depth headcount

```{r WTsel, cache=F}
trees %>% 
  filter(sel == 1) %>% 
  reshape2::dcast(WT ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

### Selected species and topography headcount

```{r toposel, cache=F}
trees %>% 
  filter(sel == 1) %>% 
  reshape2::dcast(topo ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

### Selected species and treatment headcount

```{r treatmentsel, cache=F}
trees %>% 
  filter(sel == 1) %>% 
  reshape2::dcast(treatment ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

###  Selected species and plot headcount

```{r plotsel, cache=F}
trees %>% 
  filter(sel == 1) %>% 
  reshape2::dcast(n_parcelle ~ espece) %>% 
  mutate(Total = globulifera + Indet. + sp.1) %>% 
  kable()
```

# Maps

### Dynamic map of selected individuals

```{r selected}
sel_pal <-colorBin(c('blue', 'red'), trees$sel)
leaflet() %>%
  addPolygons(data = limits, fillOpacity = 0,
              opacity = 0.5, col = 'black') %>% 
  addCircles(data = treesXY, fillOpacity = 0.6,
             col = sel_pal(trees$sel), radius= ~circonf/25,
             label = ~as.character(n_arbre)) %>% 
  addLegend(colors = c('blue', 'red'), 
            labels = c('not selected', 'selected'),
            title = 'Sampling')
```

### Maps to be printed

```{r maps functions}
rotateProj = function(spobj, angle) {
    boxpts = SpatialPoints(t(bbox(spobj)), proj4string = CRS(proj4string(spobj)))
    boxLL = bbox(spTransform(boxpts, CRS("+init=epsg:4326")))
    llc = apply(boxLL, 1, mean)
    prj = paste0("+proj=omerc +lat_0=", llc[2], " +lonc=", llc[1], " +alpha=", 
        angle, " +gamma=0.0 +k=1.000000 +x_0=0.000 +y_0=0.000 +ellps=WGS84 +units=m ")
    CRS(prj)
}
find_angle <- function(spobj){
  spobj <- subset(spobj, Subplot == unique(spobj$Subplot)[1])
  spobj <- fortify(spobj) %>% 
    filter(long == min(long) | lat == min(lat)) %>% 
    select(long, lat) %>% 
    distinct()
  row.names(spobj) <- c('A', 'B')
  spobj['C',] <- apply(spobj, 2, min)
  Pab <- sqrt(sum(apply(spobj[c('A', 'B'),], 2, diff)^2))
  Pac <- sqrt(sum(apply(spobj[c('A', 'C'),], 2, diff)^2))
  Pbc <- sqrt(sum(apply(spobj[c('B', 'C'),], 2, diff)^2))
  angle <- acos((Pab^2 + Pac^2 - Pbc^2) / (2 * Pab * Pac))
  angle <- angle*180/pi
}
make_map <- function(limits, treesXY, contour, p, c){
  limits_plot <-  subset(limits, Plot == p)
  limits_plot <-  subset(limits_plot, Subplot == c)
  if(p != 16)
    limits_plot <-  subset(limits_plot, TypeSub == "Subplots")
  else
    limits_plot <-  subset(limits_plot, TypeSub == "SubplotsP16")
  # newProj <- rotateProj(limits_plot, find_angle(limits_plot))
  # limits_plot <- spTransform(limits_plot, newProj)
  treesXY_plot <- subset(treesXY, n_parcelle == p)
  treesXY_plot <- subset(treesXY_plot, n_carre == c)
  # treesXY_plot <- spTransform(treesXY_plot, newProj)
  # contour_plot <- spTransform(contour, newProj)
  contour_plot <- crop(contour, extent(limits_plot))
  ggplot() +
    geom_polygon(data = fortify(limits_plot),
                 aes(long, lat, group=group),
                 fill = "transparent", colour = "black", alpha = 0.2) +
    geom_polygon(data = fortify(contour_plot),
                 aes(long, lat, group=group),
                 colour = "grey", alpha = 0) +
    geom_point(data = as.data.frame(treesXY_plot),
               aes(x = Xutm, y = Yutm, size=circonf/pi*100, colour = sel)) +
    geom_text_repel(data = as.data.frame(treesXY_plot),
                    aes(Xutm, Yutm, 
                        label = n_arbre)) +
    ggtitle(paste('Parcelle', p, 'carré', c)) +
    coord_equal() +
    theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none",
          panel.background=element_blank(),panel.border=element_blank(),panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank())
}
```

```{r maps, fig.height=12, fig.width=12}
ind <- trees %>% 
  select(n_parcelle, n_carre) %>% 
  distinct() %>% 
  arrange(n_parcelle, n_carre)
maps <- apply(ind, 1, function(x) make_map(limits, treesXY, contour, x[1], x[2]))
names(maps) <- unlist(ind %>% transmute(paste0('P', n_parcelle, '-', n_carre)))
cowplot::plot_grid(maps$`P1-1`, maps$`P1-2`,
                   maps$`P1-3`, maps$`P1-4`)
```

# Lab

## 

### Material

* Scanner
* Balance
* Étuve
* Micromêtre
* protocol cheatsheets
* Fresh measurements sheets

## 

### Protocol
